name: Run AgentBeats Evaluation
on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  run-agentbeats:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Show files (debug)
        run: |
          pwd
          ls -la
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install compose generator deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install tomli-w requests
      
      - name: Generate docker-compose.yml from scenario.toml
        run: |
          python generate_compose.py --scenario scenario.toml
          ls -la
          test -f docker-compose.yml
          test -f a2a-scenario.toml
          echo "=== Generated docker-compose.yml ==="
          cat docker-compose.yml
          echo ""
          echo "=== Generated a2a-scenario.toml ==="
          cat a2a-scenario.toml
      
      - name: Pull images
        run: |
          docker compose -f docker-compose.yml pull
      
      - name: Start agent services (without client)
        env:
          ZHIPUAI_API_KEY: ${{ secrets.ZHIPUAI_API_KEY }}
        run: |
          echo "Starting agent services in detached mode..."
          docker compose -f docker-compose.yml up -d green-agent lawlawlaw
          
          echo "Waiting for green-agent to be healthy..."
          for i in {1..60}; do
            status=$(docker inspect --format='{{.State.Health.Status}}' green-agent 2>/dev/null || echo "not_found")
            echo "Attempt $i/60: green-agent status = $status"
            
            if [ "$status" = "healthy" ]; then
              echo "✅ green-agent is healthy!"
              break
            fi
            
            if [ $i -eq 60 ]; then
              echo "❌ Timeout waiting for green-agent"
              docker compose -f docker-compose.yml logs green-agent
              exit 1
            fi
            
            sleep 2
          done
          
          echo "Waiting for lawlawlaw to be healthy..."
          for i in {1..30}; do
            status=$(docker inspect --format='{{.State.Health.Status}}' lawlawlaw 2>/dev/null || echo "not_found")
            echo "Attempt $i/30: lawlawlaw status = $status"
            
            if [ "$status" = "healthy" ]; then
              echo "✅ lawlawlaw is healthy!"
              break
            fi
            
            if [ $i -eq 30 ]; then
              echo "❌ Timeout waiting for lawlawlaw"
              docker compose -f docker-compose.yml logs lawlawlaw
              exit 1
            fi
            
            sleep 2
          done
          
          echo "=== All agents are healthy ==="
          docker compose -f docker-compose.yml ps
          
          echo "Testing green-agent POST endpoint..."
          docker run --rm --network leaderboard_agent-network curlimages/curl:latest \
            curl -f -X POST http://green-agent:9009/ \
            -H "Content-Type: application/json" \
            -d '{"jsonrpc":"2.0","id":1,"method":"ping","params":{}}' \
            || echo "Warning: POST test failed"
      
      - name: Test full message/send request
        run: |
          echo "=== Testing complete message/send request ==="
          docker run --rm --network leaderboard_agent-network curlimages/curl:latest \
            curl -v -X POST http://green-agent:9009/ \
            -H "Content-Type: application/json" \
            -d '{
              "jsonrpc": "2.0",
              "id": 1,
              "method": "message/send",
              "params": {
                "message": {
                  "parts": [
                    {
                      "kind": "text",
                      "text": "Test evaluation request from workflow"
                    }
                  ]
                }
              }
            }'
      
      - name: Run evaluation with all services
        env:
          ZHIPUAI_API_KEY: ${{ secrets.ZHIPUAI_API_KEY }}
        run: |
          echo "Starting complete evaluation (agents + client)..."
          docker compose -f docker-compose.yml up --timestamps --no-color --exit-code-from agentbeats-client --abort-on-container-exit
      
      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== green-agent logs ==="
          docker compose -f docker-compose.yml logs green-agent
          echo ""
          echo "=== lawlawlaw logs ==="
          docker compose -f docker-compose.yml logs lawlawlaw
          echo ""
          echo "=== agentbeats-client logs ==="
          docker compose -f docker-compose.yml logs agentbeats-client
      
      - name: Stop all services
        if: always()
        run: |
          docker compose -f docker-compose.yml down
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agentbeats-results
          path: output/
