name: Run AgentBeats Evaluation

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  run-agentbeats:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write
      packages: read
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install compose generator deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install tomli-w requests
      
      - name: Generate docker-compose.yml from scenario.toml
        run: |
          python generate_compose.py --scenario scenario.toml
          echo "=== Generated docker-compose.yml ==="
          cat docker-compose.yml
          echo ""
          echo "=== Generated a2a-scenario.toml ==="
          cat a2a-scenario.toml
      
      - name: Create output directory
        run: mkdir -p output && chmod 777 output
      
      - name: Export secrets as environment variables
        env:
          SECRETS_JSON: ${{ toJSON(secrets) }}
        run: |
          echo "$SECRETS_JSON" | jq -r 'to_entries|map("\(.key)=\(.value)")|.[]' > .env
      
      - name: Check if GHCR_TOKEN is available
        id: check_ghcr
        env:
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ -n "$GHCR_TOKEN" ]; then
            echo "has_token=true" >> $GITHUB_OUTPUT
          else
            echo "has_token=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Login to GitHub Container Registry
        if: steps.check_ghcr.outputs.has_token == 'true'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Run assessment
        run: docker compose up --timestamps --no-color --exit-code-from agentbeats-client --abort-on-container-exit
      
      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== green-agent logs ==="
          docker compose logs green-agent
          echo ""
          echo "=== lawlawlaw logs ==="
          docker compose logs lawlawlaw
          echo ""
          echo "=== agentbeats-client logs ==="
          docker compose logs agentbeats-client
      
      - name: Cleanup
        if: always()
        run: docker compose down -v || true
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agentbeats-results
          path: output/
```

---

## 关键改动

1. **删除了分步启动** - 不再先启动 agents 再启动 client
2. **直接运行 `docker compose up`** - 让 Docker Compose 自己管理依赖和启动顺序
3. **添加了 `.env` 文件生成** - 从 secrets 导出环境变量
4. **简化了整个流程** - 和官方示例保持一致

---

## 为什么这样能解决问题

你之前的方式：
```
1. 启动 green-agent 和 lawlawlaw (detached)
2. 等健康检查通过
3. 再运行 docker compose up (会重新创建容器？)
```

可能导致网络状态混乱或容器被重新创建。

新方式：
```
1. 直接 docker compose up 所有服务
2. Docker Compose 自己处理 depends_on 和健康检查
3. 一次性启动，状态清晰
