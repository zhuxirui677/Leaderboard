name: Run AgentBeats Evaluation
on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  run-agentbeats:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Show files (debug)
        run: |
          pwd
          ls -la
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install compose generator deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install tomli-w requests
      
      - name: Generate docker-compose.yml from scenario.toml
        run: |
          python generate_compose.py --scenario scenario.toml
          ls -la
          test -f docker-compose.yml
          echo "=== Generated docker-compose.yml ==="
          cat docker-compose.yml
      
      - name: Pull images
        run: |
          docker compose -f docker-compose.yml pull
      
      - name: Start agent services (without client)
        env:
          ZHIPUAI_API_KEY: ${{ secrets.ZHIPUAI_API_KEY }}
        run: |
          echo "Starting agent services in detached mode..."
          docker compose -f docker-compose.yml up -d green-agent purple_agent_1
          
          echo "Waiting for green-agent to be healthy..."
          for i in {1..60}; do
            status=$(docker inspect --format='{{.State.Health.Status}}' green-agent 2>/dev/null || echo "not_found")
            echo "Attempt $i/60: green-agent status = $status"
            
            if [ "$status" = "healthy" ]; then
              echo "✅ green-agent is healthy!"
              break
            fi
            
            if [ $i -eq 60 ]; then
              echo "❌ Timeout waiting for green-agent"
              docker compose -f docker-compose.yml logs green-agent
              exit 1
            fi
            
            sleep 2
          done
          
          echo "Waiting for purple_agent_1 to be healthy..."
          for i in {1..30}; do
            status=$(docker inspect --format='{{.State.Health.Status}}' purple_agent_1 2>/dev/null || echo "not_found")
            echo "Attempt $i/30: purple_agent_1 status = $status"
            
            if [ "$status" = "healthy" ]; then
              echo "✅ purple_agent_1 is healthy!"
              break
            fi
            
            if [ $i -eq 30 ]; then
              echo "❌ Timeout waiting for purple_agent_1"
              docker compose -f docker-compose.yml logs purple_agent_1
              exit 1
            fi
            
            sleep 2
          done
          
          echo "=== All agents are healthy ==="
          docker compose -f docker-compose.yml ps
          docker network ls
          docker network inspect leaderboard_agent-network || true
          
          echo "Testing green-agent endpoint from host..."
          docker exec green-agent curl -f http://localhost:9009/.well-known/agent-card.json || echo "Warning: localhost test failed"
          
          echo "Testing green-agent endpoint via container network..."
          docker run --rm --network leaderboard_agent-network curlimages/curl:latest curl -f http://green-agent:9009/.well-known/agent-card.json || echo "Warning: network test failed"
      
      - name: Run evaluation with all services
        env:
          ZHIPUAI_API_KEY: ${{ secrets.ZHIPUAI_API_KEY }}
        run: |
          echo "Starting complete evaluation (agents + client)..."
          docker compose -f docker-compose.yml up --timestamps --no-color --exit-code-from agentbeats-client --abort-on-container-exit
      
      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== green-agent logs ==="
          docker compose -f docker-compose.yml logs green-agent
          echo ""
          echo "=== purple_agent_1 logs ==="
          docker compose -f docker-compose.yml logs purple_agent_1
          echo ""
          echo "=== agentbeats-client logs ==="
          docker compose -f docker-compose.yml logs agentbeats-client
          echo ""
          echo "=== Network info ==="
          docker network inspect leaderboard_agent-network || true
      
      - name: Stop all services
        if: always()
        run: |
          docker compose -f docker-compose.yml down
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agentbeats-results
          path: output/
