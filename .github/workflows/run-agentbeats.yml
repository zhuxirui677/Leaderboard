name: Run AgentBeats Evaluation
on:
  workflow_dispatch:
  push:
    branches: ["main"]
jobs:
  run-agentbeats:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Show files (debug)
        run: |
          pwd
          ls -la
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install compose generator deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install tomli-w requests
      
      - name: Generate docker-compose.yml from scenario.toml
        run: |
          python generate_compose.py --scenario scenario.toml
          ls -la
          test -f docker-compose.yml
      
      - name: Pull images
        run: |
          docker compose -f docker-compose.yml pull
      
      - name: Start agents and wait for health
        run: |
          echo "Starting all agent services..."
          docker compose -f docker-compose.yml up -d green-agent
          
          echo "Waiting for green-agent to be healthy..."
          timeout=60
          elapsed=0
          while [ $elapsed -lt $timeout ]; do
            if docker compose -f docker-compose.yml ps green-agent | grep -q "healthy"; then
              echo "✅ green-agent is healthy!"
              break
            fi
            echo "Waiting... ($elapsed/$timeout seconds)"
            sleep 2
            elapsed=$((elapsed + 2))
          done
          
          if [ $elapsed -ge $timeout ]; then
            echo "❌ green-agent failed to become healthy"
            docker compose -f docker-compose.yml logs green-agent
            exit 1
          fi
          
          echo "Starting participant agents..."
          docker compose -f docker-compose.yml up -d
          
          echo "Waiting for all services to be healthy..."
          sleep 10
          docker compose -f docker-compose.yml ps
      
      - name: Run AgentBeats evaluation
        env:
          ZHIPUAI_API_KEY: ${{ secrets.ZHIPUAI_API_KEY }}
        run: |
          echo "Starting agentbeats-client..."
          docker compose -f docker-compose.yml up --timestamps --no-color --exit-code-from agentbeats-client --abort-on-container-exit
      
      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== green-agent logs ==="
          docker compose -f docker-compose.yml logs green-agent
          echo "=== agentbeats-client logs ==="
          docker compose -f docker-compose.yml logs agentbeats-client
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: agentbeats-results
          path: output/
